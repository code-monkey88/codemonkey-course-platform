# 009: è¬›åº§ç®¡ç†ï¼ˆCRUDï¼‰

## æ¦‚è¦
ç®¡ç†ç”»é¢ã§è¬›åº§ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆã‚’è¡Œã†æ©Ÿèƒ½ã€‚

## å®Œäº†æ¡ä»¶
- è¬›åº§ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- æ–°è¦è¬›åº§ã‚’ä½œæˆã§ãã‚‹
- æ—¢å­˜è¬›åº§ã‚’ç·¨é›†ã§ãã‚‹
- è¬›åº§ã‚’å‰Šé™¤ã§ãã‚‹ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
- è¬›åº§ã®ä¸¦ã³é †ã‚’å¤‰æ›´ã§ãã‚‹

---

## Todo

### è¬›åº§ä¸€è¦§ãƒšãƒ¼ã‚¸
- [x] `app/(admin)/admin/courses/page.tsx` ä½œæˆ
- [x] å…¨è¬›åº§ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
- [x] å„è¡Œã«ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
- [x] æ–°è¦ä½œæˆãƒœã‚¿ãƒ³
- [x] ä¸¦ã³æ›¿ãˆUIï¼ˆä¸Šä¸‹ãƒœã‚¿ãƒ³ï¼‰

### è¬›åº§ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
- [x] `components/admin/courses-table.tsx` ä½œæˆ
- [x] ã‚«ãƒ©ãƒ : é †åºã€ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ¬ãƒ™ãƒ«ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°ã€å‹•ç”»æ•°ã€æ“ä½œ
- [x] ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã§è¡¨ç¤ºï¼ˆorder_indexé †ï¼‰

### æ–°è¦è¬›åº§ä½œæˆ
- [x] `app/(admin)/admin/courses/new/page.tsx` ä½œæˆ
- [x] è¬›åº§ä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
- [x] å…¥åŠ›é …ç›®:
  - [x] ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰
  - [x] èª¬æ˜
  - [x] ãƒ¬ãƒ™ãƒ«ï¼ˆé¸æŠ: beginner/intermediate/advancedï¼‰
  - [x] ã‚µãƒ ãƒã‚¤ãƒ«URL
- [x] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [x] ä½œæˆå¾Œã¯è¬›åº§ä¸€è¦§ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### è¬›åº§ç·¨é›†
- [x] `app/(admin)/admin/courses/[courseId]/edit/page.tsx` ä½œæˆ
- [x] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åˆæœŸè¡¨ç¤º
- [x] æ›´æ–°å‡¦ç†
- [x] æ›´æ–°å¾Œã¯è¬›åº§ä¸€è¦§ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### è¬›åº§å‰Šé™¤
- [x] å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆshadcn/ui AlertDialogï¼‰
- [x] é–¢é€£ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ»å‹•ç”»ã‚‚å‰Šé™¤ã•ã‚Œã‚‹æ—¨ã‚’è­¦å‘Š
- [x] å‰Šé™¤å‡¦ç†ï¼ˆCASCADE ã§è‡ªå‹•å‰Šé™¤ï¼‰

### ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½
- [x] `components/admin/courses-table.tsx` ã§å®Ÿè£…
- [x] ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§ä¸¦ã³æ›¿ãˆ
- [x] ä¸¦ã³æ›¿ãˆå¾Œã« order_index ã‚’ä¸€æ‹¬æ›´æ–°
- [x] æ¥½è¦³çš„UIæ›´æ–°

### Server Actions
- [x] `app/(admin)/admin/courses/actions.ts` ä½œæˆ
- [x] `createCourse` - è¬›åº§ä½œæˆ
- [x] `updateCourse` - è¬›åº§æ›´æ–°
- [x] `deleteCourse` - è¬›åº§å‰Šé™¤
- [x] `reorderCourses` - ä¸¦ã³æ›¿ãˆ

### ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [x] `components/admin/course-form.tsx` ä½œæˆ
- [x] ä½œæˆãƒ»ç·¨é›†ã§å…±é€šåˆ©ç”¨
- [x] props ã§åˆæœŸå€¤ã¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆcreate/editï¼‰ã‚’å—ã‘å–ã‚‹

---

## ç”»é¢æ§‹æˆ

### è¬›åº§ä¸€è¦§
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¬›åº§ç®¡ç†                        [+ æ–°è¦ä½œæˆ]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ # â”‚ ã‚¿ã‚¤ãƒˆãƒ«    â”‚ãƒ¬ãƒ™ãƒ«â”‚ï½¾ï½¸ï½¼ï½®ï¾â”‚ å‹•ç”» â”‚ æ“ä½œâ”‚  â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 1 â”‚ åˆç´šè¬›åº§    â”‚ åˆç´š â”‚  4   â”‚  12  â”‚ âœ ğŸ—‘â”‚  â”‚
â”‚  â”‚ 2 â”‚ ä¸­ç´šè¬›åº§    â”‚ ä¸­ç´š â”‚  5   â”‚  15  â”‚ âœ ğŸ—‘â”‚  â”‚
â”‚  â”‚ 3 â”‚ ä¸Šç´šè¬›åº§    â”‚ ä¸Šç´š â”‚  3   â”‚  10  â”‚ âœ ğŸ—‘â”‚  â”‚
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¬›åº§ä½œæˆ/ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°è¦è¬›åº§ä½œæˆ / è¬›åº§ç·¨é›†                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  ã‚¿ã‚¤ãƒˆãƒ« *                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AIå…¥é–€è¬›åº§                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  èª¬æ˜                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AIãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤ã‚’å­¦ã¶è¬›åº§ã§ã™ã€‚      â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  ãƒ¬ãƒ™ãƒ« *                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â–¼ åˆç´š                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  ã‚µãƒ ãƒã‚¤ãƒ«URL                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ https://example.com/thumbnail.jpg         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]                        [ä¿å­˜]      â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‚è€ƒã‚³ãƒ¼ãƒ‰

### è¬›åº§ä½œæˆ Server Action
```typescript
// app/(admin)/admin/courses/actions.ts
'use server'

import { createServerClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export async function createCourse(formData: FormData) {
  const supabase = await createServerClient()

  const title = formData.get('title') as string
  const description = formData.get('description') as string
  const level = formData.get('level') as string
  const thumbnailUrl = formData.get('thumbnailUrl') as string

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!title) throw new Error('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™')
  if (!['beginner', 'intermediate', 'advanced'].includes(level)) {
    throw new Error('ç„¡åŠ¹ãªãƒ¬ãƒ™ãƒ«ã§ã™')
  }

  // ç¾åœ¨ã®æœ€å¤§order_indexã‚’å–å¾—
  const { data: maxOrder } = await supabase
    .from('courses')
    .select('order_index')
    .order('order_index', { ascending: false })
    .limit(1)
    .single()

  const orderIndex = (maxOrder?.order_index ?? 0) + 1

  const { error } = await supabase
    .from('courses')
    .insert({
      title,
      description: description || null,
      level,
      thumbnail_url: thumbnailUrl || null,
      order_index: orderIndex,
    })

  if (error) throw error

  revalidatePath('/admin/courses')
  redirect('/admin/courses')
}

export async function deleteCourse(courseId: string) {
  const supabase = await createServerClient()

  const { error } = await supabase
    .from('courses')
    .delete()
    .eq('id', courseId)

  if (error) throw error

  revalidatePath('/admin/courses')
}

export async function reorderCourses(orderedIds: string[]) {
  const supabase = await createServerClient()

  const updates = orderedIds.map((id, index) => ({
    id,
    order_index: index + 1,
  }))

  for (const update of updates) {
    await supabase
      .from('courses')
      .update({ order_index: update.order_index })
      .eq('id', update.id)
  }

  revalidatePath('/admin/courses')
}
```
